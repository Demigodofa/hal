############################
# windows/install_to_genesis.ps1
############################
Param(
  [string]$ZipPath = "hal-relay.zip",
  [string]$TargetDir = "HalRelay"
)

# why: run once to copy hal-relay.zip to the external SSD named GENESIS

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

if (-not (Test-Path $ZipPath)) {
  Write-Error "Zip not found: $ZipPath"
}

try {
  $vol = Get-Volume -FileSystemLabel 'GENESIS' | Select-Object -First 1
} catch {
  try {
    # fallback for older PowerShell
    $vol = Get-WmiObject Win32_Volume -Filter 'Label="GENESIS"' | Select-Object -First 1
    if ($vol -and $vol.DriveLetter) { $vol = [pscustomobject]@{ DriveLetter = $vol.DriveLetter.TrimEnd(':') } }
  } catch { $vol = $null }
}

if (-not $vol) { throw "Could not find a mounted volume labeled GENESIS" }

$drive = "$($vol.DriveLetter):\"
$dest = Join-Path $drive $TargetDir

if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }

Write-Host "Installing to" $dest
Expand-Archive -Path $ZipPath -DestinationPath $dest -Force

Write-Host "Done. Files at $dest\hal-relay"
Write-Host "Next: run $dest\hal-relay\windows\run_relay.ps1"


############################
# windows/run_relay.ps1
############################
Param(
  [string]$Secret = "",
  [string]$Label = "GENESIS",
  [string]$Host = "127.0.0.1",
  [int]$Port = 8765
)

# why: bootstrap python venv, install deps, run the local relay preferring SSD named GENESIS

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

function Find-ProjectRoot {
  # Accept both when executed from \\hal-relay or its parent
  $here = Split-Path -Parent $MyInvocation.MyCommand.Path
  $root = Resolve-Path (Join-Path $here '..') -ErrorAction SilentlyContinue
  if (Test-Path (Join-Path $here 'local_relay\requirements.txt')) { return $here }
  elseif ($root -and (Test-Path (Join-Path $root 'local_relay\requirements.txt'))) { return $root }
  else { throw 'Cannot locate local_relay/requirements.txt' }
}

$proj = Find-ProjectRoot
Set-Location $proj

# Python venv
$venv = Join-Path $proj '.venv'
if (-not (Test-Path $venv)) {
  try { & py -3 -m venv $venv } catch { & py -m venv $venv }
}

$python = Join-Path $venv 'Scripts\python.exe'
if (-not (Test-Path $python)) { throw 'Python venv not created (is Python/py launcher installed?)' }

& $python -m pip install --upgrade pip > $null
& $python -m pip install -r (Join-Path $proj 'local_relay\requirements.txt')

if ($Secret) { $env:HAL_RELAY_SECRET = $Secret }
$env:HAL_SSD_LABEL = $Label

Write-Host "Starting relay on http://$Host:$Port (label=$Label)"
& $python -m local_relay.app --host $Host --port $Port --ssd-label $Label


############################
# WINDOWS_STEPS.md
############################
# Windows: Step-by-step to put this on the GENESIS SSD

> No admin rights required.

## A) Create the ZIP (on any machine)
1. Open **PowerShell** in the folder that contains `pack.ps1`.
2. Allow script just for this session:
   ```powershell
   Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
   Unblock-File .\pack.ps1
   .\pack.ps1
   ```
3. You now have `hal-relay.zip`.

## B) Copy to the SSD named **GENESIS**
Option 1 – **Scripted** (auto-detect drive letter):
```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
.\windows\install_to_genesis.ps1 -ZipPath .\hal-relay.zip -TargetDir HalRelay
```
This creates `GENESIS:\HalRelay\hal-relay\...`.

Option 2 – **Manual**:
- Plug in the SSD. Find its drive letter (e.g. `E:`) in File Explorer.
- Right-click `hal-relay.zip` → **Extract All…** → choose `E:\HalRelay`.

## C) Run the local relay from the SSD
1. Open PowerShell and `cd` into the installed folder:
   ```powershell
   cd (Join-Path (Get-Volume -FileSystemLabel 'GENESIS').DriveLetter ':\HalRelay\hal-relay')
   ```
2. Start it:
   ```powershell
   Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
   .\windows\run_relay.ps1 -Secret "<your-shared-secret>" -Label GENESIS -Host 127.0.0.1 -Port 8765
   ```
   Keep this window open; it’s the running relay.

## D) Load the Chrome Extension
1. Open Chrome → `chrome://extensions` → **Developer mode** (toggle top right).
2. Click **Load unpacked** → select `GENESIS\HalRelay\hal-relay\extension`.
3. Open **Options** on the extension and set:
   - Render URL: `https://hal-ku4c.onrender.com/kev_ai/listener`
   - Local URL: `http://127.0.0.1:8765/kev_ai/listener`
   - Shared Secret: the same value you passed to `run_relay.ps1`
   - Route Strategy: `auto`

## E) Test from ChatGPT
Paste this in ChatGPT:
```
[KEV_AI::command]
{ "id":"write-001","target":"local","op":"file_ops.write_file",
  "args":{"path":"memory/short_term/seed.json","content":"{\"ok\":true}\n"} }
[/KEV_AI::command]
```
- The code block should get a green outline.
- Check `GENESIS\memory\short_term\seed.json` for the file.

## Troubleshooting
- **Script blocked?** Use the `Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force` line again.
- **Python not found?** Install Python or use the Microsoft Store “Python 3.x”; ensure `py` launcher exists.
- **No GENESIS drive found?** Confirm the volume label is exactly `GENESIS` (right‑click the drive → Properties → rename).
