<!doctype html>


// Local
if(target==='local'){
if(!ssdRoot){ log('local: no SSD selected'); showPermBanner(); }
else {
if(op==='file_ops.read_file'||op==='read_file'){ log('local read:', await readFile(ssdRoot,a.path)); }
else if(op==='file_ops.write_file'||op==='write_file'){ log('local write:', await writeFile(ssdRoot,a.path,a.content||'')); }
else if(op==='file_ops.list_dir'||op==='list_dir'){ log('local list:', await listDir(ssdRoot,a.path||'.')); }
else if(op==='file_ops.mkdirs'||op==='mkdirs'){ await ensureDir(ssdRoot,a.path); log('local mkdirs ok:', a.path); }
else if(op==='file_ops.delete_file'||op==='delete_file'){ log('local delete:', await deleteFile(ssdRoot,a.path)); }
else if(op==='file_ops.append_file'||op==='append_file'){
const mode=String(a.mode||'text').toLowerCase();
if(mode==='json-array'){ const obj=a.json ?? (a.content?JSON.parse(a.content):{}); log('local append (json-array):', await appendJsonArray(ssdRoot,a.path,obj)); }
else if(mode==='jsonl'){ const obj=a.json ?? (a.content?JSON.parse(a.content):{}); log('local append (jsonl):', await appendJsonl(ssdRoot,a.path,obj)); }
else { const ensure = a.ensureNewline!==false; log('local append (text):', await appendText(ssdRoot,a.path,a.content||'',ensure)); }
}
else if(op==='relay.checkpoint_now'){ await checkpointNow(); }
else if(op==='relay.scheduler'){ if(a.enabled){ startScheduler(a.interval_mins||30); $('#schedEnable').checked=true; $('#schedEvery').value=String(a.interval_mins||30); } else { stopScheduler(); $('#schedEnable').checked=false; } maybeSave(); }
else { log('local unknown op:', op); }
}
}


// GitHub (bypass forced ON)
if(target==='render' || op.startsWith('github.')){
if(!op.startsWith('github.')){ log('render disabled (bypass ON): op not github.* ->', op); }
else {
const repo=a.repo||$('#ghRepo').value.trim();
if(op==='github.put_file'){ const out=await ghPutFile({repo,path:a.path,content:a.content||'',message:a.message||'',branch:a.branch||$('#ghBranch').value.trim()}); log('github put_file:', {path:a.path, commit:(out&&out.commit&&out.commit.sha?out.commit.sha.slice(0,7):'')}); }
else { log('github op not supported:', op); }
}
}


if($('#autoClear').value==='1') $('#cmdInput').value='';
}catch(e){ log('error:', e?.message||e); }
}
$('#runOnce').addEventListener('click', processOnce);
$('#clearLog').addEventListener('click', ()=>{ $('#log').textContent=''; });


// ---- Permission banner & reconnect ----
function showPermBanner(){ if(document.getElementById('permBanner')) return; const b=document.createElement('div'); b.id='permBanner'; b.innerHTML='<span>HAL needs SSD access to <b>GENESIS</b>.</span> <button id="grantSsd">Grant SSD Access</button>'; document.body.appendChild(b); document.getElementById('grantSsd').onclick=()=>reconnectSsd(true); }
function hidePermBanner(){ const b=document.getElementById('permBanner'); if(b) b.remove(); }


// ---- Clipboard watcher (optional) ----
let watchTimer=null; $('#watchClipboard').addEventListener('click', async (e)=>{ if(watchTimer){ clearInterval(watchTimer); watchTimer=null; e.target.textContent='Watch Clipboard'; return;} try{ await navigator.permissions.query({name:'clipboard-read'});}catch{} e.target.textContent='Watchingâ€¦'; let last=''; watchTimer=setInterval(async()=>{ try{ const t=await navigator.clipboard.readText(); if(t && t!==last && t.includes('[KEV_AI::command]')){ last=t; $('#cmdInput').value=t; log('clipboard captured block'); await processOnce(); } }catch{} },1200); });


// ---- Auto-exec queue from extension/bookmarklet ----
(function(){ const Q=[]; let busy=false; async function run(raw){ $('#cmdInput').value='[KEV_AI::command]\n'+raw+'\n[/KEV_AI::command]'; await processOnce(); } async function pump(){ if(busy) return; busy=true; try{ while(Q.length){ await run(Q.shift()); } } finally { busy=false; } } window.addEventListener('message',(ev)=>{ const d=ev.data||{}; if(d.type==='HAL_PAYLOAD' && typeof d.raw==='string'){ Q.push(d.raw); pump(); } if(d.type==='HAL_CONTROL' && d.cmd==='settings' && d.settings){ try{ const s=d.settings; if(s.ghToken!==undefined){ $('#ghToken').value=s.ghToken; } if(s.ghRepo){ $('#ghRepo').value=s.ghRepo; } if(s.ghBranch){ $('#ghBranch').value=s.ghBranch; } const rs=$('#rememberSettings'); if(rs&&!rs.checked){ rs.checked=true; } maybeSave(); }catch{} } if(d.type==='HAL_CONTROL' && d.cmd==='reconnect'){ reconnectSsd(false); } if(d.type==='HAL_CONTROL' && d.cmd==='scheduler'){ if(d.settings && d.settings.enabled){ startScheduler(d.settings.interval_mins||30); $('#schedEnable').checked=true; $('#schedEvery').value=String(d.settings.interval_mins||30);} else { stopScheduler(); $('#schedEnable').checked=false; } maybeSave(); } if(d.type==='HAL_CONTROL' && d.cmd==='checkpoint_now'){ checkpointNow(); } }); })();
})();
</script>
</body>
</html>
